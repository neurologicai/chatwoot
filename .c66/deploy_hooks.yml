hooks:
  before_rails:
    - name: "Instalar Node.js 23 e pnpm 10"
      command: |
        # Remover versão antiga se existir
        sudo apt-get remove -y nodejs npm
        # Instalar Node.js 23.x
        curl -fsSL https://deb.nodesource.com/setup_23.x | sudo -E bash -
        sudo apt-get install -y nodejs
        echo "Node.js $(node --version) instalado"
        
        # Instalar pnpm 10.x
        sudo npm install -g pnpm@10.2.0
        echo "pnpm $(pnpm --version) instalado"
      user: "deploy"
      run_on: "all_servers"
      fail_on_error: true

    - name: "Instalar dependências JavaScript com pnpm"
      command: |
        # Usar pnpm install para instalar dependências
        pnpm install --frozen-lockfile
        echo "Dependências JavaScript instaladas com pnpm"
      user: "deploy"
      run_on: "all_servers"
      fail_on_error: true

    - name: "Compilar assets com Vite"
      command: |
        export RAILS_ENV=production
        export RAILS_GROUPS=assets
        bundle exec rake assets:precompile
        echo "Assets compilados com sucesso"
      user: "deploy"
      run_on: "all_servers"
      fail_on_error: true

    - name: "Verificar configuração do banco"
      command: "ruby -e \"require 'erb'; require 'yaml'; YAML.load(ERB.new(File.read('config/database.yml')).result)\""
      user: "deploy"
      run_on: "all_servers"
      fail_on_error: true

  after_deploy:
    - name: "Rodar migrações"
      command: "bundle exec rails db:migrate"
      user: "deploy"
      run_on: "all_servers"
      fail_on_error: true

    - name: "Verificar conexão com o banco"
      command: "bundle exec rails runner \"ActiveRecord::Base.connection.execute('SELECT 1')\""
      user: "deploy"
      run_on: "all_servers"
      fail_on_error: true

    - name: "Limpar cache"
      command: "bundle exec rails tmp:cache:clear"
      user: "deploy"
      run_on: "all_servers"
      fail_on_error: false

    - name: "Reiniciar Sidekiq"
      command: "bundle exec sidekiqctl quiet && bundle exec sidekiqctl stop"
      user: "deploy"
      run_on: "sidekiq_servers"
      fail_on_error: false